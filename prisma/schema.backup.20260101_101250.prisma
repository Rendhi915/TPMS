generator client {
  provider        = "prisma-client-js"
  output          = "./generated/client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgcrypto]
}

model alert {
  id            Int            @id @default(autoincrement())
  code          String         @unique @db.VarChar(50)
  name          String         @db.VarChar(255)
  description   String?
  severity      String         @default("warning") @db.VarChar(20)
  threshold_min Float?         @db.Real
  threshold_max Float?         @db.Real
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  updated_at    DateTime       @default(now()) @db.Timestamptz(6)
  deleted_at    DateTime?      @db.Timestamptz(6)
  alert_events  alert_events[]

  @@index([code], map: "idx_alert_code")
  @@index([severity], map: "idx_alert_severity")
}

model alert_events {
  id          Int       @id @default(autoincrement())
  alert_id    Int
  device_id   Int?
  sensor_id   Int?
  truck_id    Int?
  value       Float?    @db.Real
  message     String?
  status      String    @default("active") @db.VarChar(20)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  resolved_at DateTime? @db.Timestamptz(6)
  alert       alert     @relation(fields: [alert_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  device      device?   @relation(fields: [device_id], references: [id], onUpdate: NoAction)
  sensor      sensor?   @relation(fields: [sensor_id], references: [id], onUpdate: NoAction)
  truck       truck?    @relation(fields: [truck_id], references: [id], onUpdate: NoAction)

  @@index([alert_id], map: "idx_alert_events_alert_id")
  @@index([device_id], map: "idx_alert_events_device_id")
  @@index([sensor_id], map: "idx_alert_events_sensor_id")
  @@index([status], map: "idx_alert_events_status")
  @@index([truck_id], map: "idx_alert_events_truck_id")
}

model device {
  id             Int              @id @default(autoincrement())
  truck_id       Int
  sn             String           @unique @db.VarChar(50)
  sim_number     String?          @db.VarChar(50)
  installed_at   DateTime         @default(now()) @db.Timestamptz(6)
  bat1           Int?             @db.SmallInt
  bat2           Int?             @db.SmallInt
  bat3           Int?             @db.SmallInt
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime?        @db.Timestamptz(6)
  lock           Int              @default(0) @db.SmallInt
  status         String           @default("active") @db.VarChar(50)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  alert_events   alert_events[]
  truck          truck            @relation(fields: [truck_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  location       location[]
  sensor         sensor[]
  sensor_history sensor_history[]

  @@index([sn], map: "idx_device_sn")
  @@index([truck_id], map: "idx_device_truck")
}

model drivers {
  id             Int       @id @default(autoincrement())
  name           String    @db.VarChar(255)
  phone          String?   @db.VarChar(50)
  email          String?   @db.VarChar(255)
  license_number String    @db.VarChar(50)
  license_type   String    @db.VarChar(20)
  license_expiry DateTime  @db.Date
  vendor_id      Int?
  status         String    @default("aktif") @db.VarChar(20)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime? @db.Timestamptz(6)
  vendors        vendors?  @relation(fields: [vendor_id], references: [id], onUpdate: NoAction)
  truck          truck[]

  @@index([license_expiry], map: "idx_drivers_license_expiry")
  @@index([status], map: "idx_drivers_status")
  @@index([vendor_id], map: "idx_drivers_vendor_id")
}

model location {
  id             Int              @id @default(autoincrement())
  device_id      Int
  lat            Float
  long           Float
  speed          Float?           @default(0) @db.Real // Speed in km/h from GPS
  heading        Float?           @default(0) @db.Real // Heading/direction in degrees (0-360)
  altitude       Float?           @db.Real // Altitude in meters (optional)
  accuracy       Float?           @db.Real // GPS accuracy in meters (optional)
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  recorded_at    DateTime         @default(now()) @db.Timestamptz(6)
  device         device           @relation(fields: [device_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sensor_history sensor_history[]

  @@index([device_id], map: "idx_location_device_id")
  @@index([recorded_at], map: "idx_location_recorded_at")
  @@index([speed], map: "idx_location_speed")
}

model sensor {
  id          Int     @id @default(autoincrement())
  device_id   Int
  sn          String  @unique @db.VarChar(50)
  tireNo      Int
  simNumber   String? @db.VarChar(50)
  sensorNo    Int?
  sensor_lock Int     @default(0) @db.SmallInt
  status      String  @default("active") @db.VarChar(20)

  // Sensor data fields - stored directly in sensor table for live tracking
  tempValue  Float?  @db.Real // Temperature value in Celsius
  tirepValue Float?  @db.Real // Tire pressure value in PSI
  exType     String? @db.VarChar(50) // Exception type: normal, warning, critical
  bat        Int?    @db.SmallInt // Battery level percentage (0-100)

  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  alert_events   alert_events[]
  sensor_history sensor_history[]
  device         device           @relation(fields: [device_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([device_id], map: "idx_sensor_device_id")
  @@index([sn], map: "idx_sensor_sn")
  @@index([tireNo], map: "idx_sensor_tireNo")
  @@index([updated_at], map: "idx_sensor_updated_at")
}

model sensor_history {
  id          Int      @id @default(autoincrement())
  location_id Int
  sensor_id   Int
  device_id   Int
  truck_id    Int
  tireNo      Int // Tire position 1-10
  sensorNo    Int? // Sensor number 1-10
  tempValue   Float   @db.Real // Temperature snapshot in Celsius
  tirepValue  Float   @db.Real // Tire pressure snapshot in PSI
  exType      String  @default("normal") @db.VarChar(50) // Status snapshot: normal, warning, critical
  bat         Int?    @db.SmallInt // Battery level snapshot (0-100)
  recorded_at DateTime @db.Timestamptz(6) // Same timestamp as location
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  location location @relation(fields: [location_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sensor   sensor   @relation(fields: [sensor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  device   device   @relation(fields: [device_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  truck    truck    @relation(fields: [truck_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([location_id], map: "idx_sensor_history_location_id")
  @@index([sensor_id], map: "idx_sensor_history_sensor_id")
  @@index([device_id], map: "idx_sensor_history_device_id")
  @@index([truck_id], map: "idx_sensor_history_truck_id")
  @@index([recorded_at], map: "idx_sensor_history_recorded_at")
  @@index([tireNo], map: "idx_sensor_history_tireNo")
}

/// This table is managed by PostGIS extension
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)

  @@ignore
}

model truck {
  id             Int              @id @default(autoincrement())
  vin            String?          @unique @db.VarChar(50)
  name           String           @db.VarChar(255)
  model          String?          @db.VarChar(255)
  year           Int?
  vendor_id      Int?
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  created_by     Int?
  updated_by     Int?
  deleted_at     DateTime?        @db.Timestamptz(6)
  driver_id      Int?
  image          String?          @db.VarChar(255)
  plate          String?          @unique @db.VarChar(50)
  status         String           @default("active") @db.VarChar(50)
  type           String?          @db.VarChar(100)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  alert_events   alert_events[]
  device         device[]
  sensor_history sensor_history[]
  drivers        drivers?         @relation(fields: [driver_id], references: [id], onUpdate: NoAction)
  vendors        vendors?         @relation(fields: [vendor_id], references: [id], onUpdate: NoAction)

  @@index([plate], map: "idx_truck_plate")
  @@index([vendor_id], map: "idx_truck_vendor_id")
  @@index([vin], map: "idx_truck_vin")
}

model user_admin {
  id                 Int       @id @default(autoincrement())
  name               String    @db.VarChar(255)
  email              String    @unique @db.VarChar(255)
  password           String    @db.VarChar(255)
  role               String    @default("admin") @db.VarChar(50)
  phone              String?   @db.VarChar(50)
  department         String?   @db.VarChar(100)
  bio                String?   @db.Text
  avatar             String?   @db.VarChar(500)
  two_factor_enabled Boolean   @default(false)
  last_login         DateTime? @db.Timestamptz(6)
  status             String    @default("active") @db.VarChar(20)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at         DateTime? @db.Timestamptz(6)

  @@index([email], map: "idx_user_admin_email")
  @@index([status], map: "idx_user_admin_status")
  @@index([role], map: "idx_user_admin_role")
}

model vendors {
  id             Int       @id @default(autoincrement())
  address        String?
  email          String?   @db.VarChar(255)
  contact_person String?   @db.VarChar(255)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime? @db.Timestamptz(6)
  name_vendor    String    @db.VarChar(255)
  telephone      String?   @db.VarChar(50)
  drivers        drivers[]
  truck          truck[]

  @@index([name_vendor], map: "idx_vendors_nama")
}
